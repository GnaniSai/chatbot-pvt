<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PsyDevs Chatbot</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="response-box scroll-bar"></div>

      <form id="userTextBox">
        <div class="input-box">
          <textarea
            class="scroll-bar"
            name="chatbox"
            id="chatbox"
            placeholder="Let's Chat"
          ></textarea>
        </div>
        <div>
          <button type="submit" id="submit">
            <span
              ><img src="assets/icons/send.svg" alt="send button" width="25px"
            /></span>
          </button>
        </div>
      </form>
    </div>

    <script>
      let textarea = document.querySelector("textarea");
      textarea.addEventListener("keyup", (e) => {
        textarea.style.height = "auto";
        textarea.style.height = `${textarea.scrollHeight}px`;
      });

      let userTextBox = document.querySelector("#userTextBox");
      let responseBox = document.querySelector(".response-box");
      let button = document.querySelector("#submit");

      let savedResponses = JSON.parse(localStorage.getItem("localdata")) || [];
      let i = savedResponses.length + 1;

      const displayHistory = () => {
        const entries = savedResponses;
        entries.forEach((entry) => {
          let data = `<div class="responses" id = "response${entry.id}">
                <div class="user" id ="user${entry.id}">${entry.user}</div>
                <div class="ai-response" id ="ai-response${entry.id}">${entry.ai}</div>
              </div>`;
          responseBox.insertAdjacentHTML("beforeend", data);
        });
      };

      displayHistory();

      userTextBox.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (textarea.value === "") {
          textarea.placeholder = "Please type something";
        } else {
          let data = `<div class="responses" id = "response${i}">
                <div class="user" id ="user${i}"></div>
                <div class="ai-response" id ="ai-response${i}">Loading.....</div>
              </div>`;
          responseBox.insertAdjacentHTML("beforeend", data);
          button.disabled = true;
          button.style.cursor = "not-allowed";
          let user = document.querySelector(`#user${i}`);
          user.textContent = textarea.value;
          textarea.value = "";
          textarea.style.height = "auto";
          document
            .querySelector(`#response${i}`)
            .scrollIntoView({ behavior: "smooth", block: "start" });

          try {
            let response = await fetch("http://localhost:3000/chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userPrompt: user.textContent }),
            });

            let aiResponse = await response.json();
            console.log(aiResponse);
            let updateAiResponse = document.querySelector(`#ai-response${i}`);
            updateAiResponse.innerHTML = aiResponse.message;

            document
              .querySelector(`#response${i}`)
              .scrollIntoView({ behavior: "smooth", block: "start" });

            savedResponses.push({
              id: i,
              user: user.textContent,
              ai: aiResponse.message,
            });
            localStorage.setItem("localdata", JSON.stringify(savedResponses));
            i++;
          } catch (error) {
            console.log("Error: ", error);
          }
          button.disabled = false;
          button.style.cursor = "pointer";
        }
        console.log(savedResponses);
      });
    </script>
  </body>
</html>
